<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JACOB'S ARCADE V4 — Neon</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#05030a;
    --panel:#0c0b11;
    --neon:#00e6ff;
    --neon-2:#7cff00;
    --muted:rgba(255,255,255,0.14);
    --glass: rgba(255,255,255,0.02);
    --accent: linear-gradient(90deg,var(--neon),var(--neon-2));
    --card-radius:12px;
    --shadow: 0 14px 40px rgba(0,174,255,0.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Press Start 2P",Arial,Helvetica,sans-serif;background:var(--bg);color:#e9fbff;overflow-x:hidden}
  header{position:sticky;top:0;z-index:60;background:rgba(0,0,0,0.28);backdrop-filter:blur(4px);border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;padding:12px 18px}
  .left-row{display:flex;align-items:center;gap:12px}
  .logo{width:52px;height:52px;border-radius:10px;background:var(--accent);color:#001;display:flex;align-items:center;justify-content:center;font-weight:700;animation:neonPulse 3s infinite}
  h1{font-size:14px;margin:0;color:var(--neon)}
  .top-controls{display:flex;align-items:center;gap:8px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.05);padding:8px 10px;border-radius:8px;color:var(--neon);cursor:pointer;font-size:11px}
  .btn.small{padding:6px 8px;font-size:10px}
  .btn.ghost{color:var(--neon-2);border-color:rgba(255,255,255,0.03)}
  #deploy-proxy-btn{position:relative;left:0;transform:none;padding:8px 14px;border-radius:12px;background:var(--accent);color:#001;border:none;cursor:pointer;box-shadow:0 8px 28px rgba(0,200,255,0.06)}
  /* layout */
  .container{display:grid;grid-template-columns:220px 1fr;gap:18px;padding:18px}
  @media(max-width:980px){.container{grid-template-columns:1fr;padding:12px}}
  /* sidebar */
  .sidebar{background:var(--panel);border-radius:var(--card-radius);padding:12px;border:1px solid rgba(255,255,255,0.02);height:calc(100vh - 110px);overflow:auto}
  .profile{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .avatar{width:54px;height:54;border-radius:8px;background:var(--glass);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px}
  .profile h3{margin:0;font-size:12px;color:var(--neon)}
  .category-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .category{padding:8px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.02);font-size:12px;color:var(--muted)}
  .category.active{background:rgba(0,230,255,0.06);color:var(--neon)}
  /* main */
  .main{overflow:auto;padding-bottom:80px}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
  #search-games{flex:1;min-width:240px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:var(--neon);font-size:12px}
  .small{font-size:11px;padding:6px 8px}
  .banner{padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(0,0,0,0.4),rgba(255,255,255,0.02));text-align:center;margin-bottom:12px;color:var(--neon-2);font-size:11px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:10px;border:1px solid rgba(255,255,255,0.03);transition:transform .15s,box-shadow .15s;position:relative;overflow:hidden}
  .card:hover{transform:translateY(-6px);box-shadow:var(--shadow)}
  .thumb{width:100%;height:110px;border-radius:8px;display:block;object-fit:cover;background:#0b0b0f}
  .title{font-size:11px;margin:8px 0;color:var(--neon)}
  .card-ctrls{display:flex;gap:8px;flex-wrap:wrap}
  .tiny{font-size:10px;padding:6px 7px;border-radius:8px}
  .fav{position:absolute;right:8px;top:8px;font-size:14px;cursor:pointer}
  .tag{display:inline-block;padding:4px 8px;border-radius:8px;font-size:10px;color:var(--muted);border:1px solid rgba(255,255,255,0.02);margin-right:6px}
  /* loading overlay */
  #loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.78);z-index:4000;animation:fadeIn .18s ease}
  .load-box{width:min(520px,92%);background:rgba(255,255,255,0.03);padding:18px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.06)}
  .loading-msg{font-size:12px;margin-bottom:12px}
  .progress{width:100%;height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--neon),var(--neon-2));box-shadow:0 6px 18px rgba(0,230,255,0.08);transition:width .16s linear}
  /* proxy overlay full page */
  #proxy-overlay{position:fixed;inset:0;display:none;flex-direction:column;z-index:5000;background:#000;}
  #proxy-iframe{flex:1;border:0;width:100%;height:100%}
  #proxy-back{position:fixed;left:12px;top:12px;z-index:5100;border-radius:8px;padding:8px 10px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.06);cursor:pointer;color:var(--neon-2);backdrop-filter:blur(2px)}
  /* cloak overlay */
  #cloak-overlay{position:fixed;inset:0;display:none;z-index:7000;background:#f6f6f6;color:#111;align-items:flex-start}
  .doc-header{height:60px;background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px;padding:12px}
  .doc-input{width:320px;padding:8px;border-radius:6px;border:1px solid #ddd}
  .help{font-size:11px;color:#444;margin-left:12px}
  footer{padding:12px;text-align:center;color:var(--muted);font-size:11px}
  @keyframes neonPulse {0%{box-shadow:0 0 6px rgba(0,230,255,0.08)}50%{box-shadow:0 0 20px rgba(0,230,255,0.12)}100%{box-shadow:0 0 6px rgba(0,230,255,0.08)}}
  @keyframes fadeIn {from{opacity:0}to{opacity:1}}
  @media(max-width:520px){ .thumb{height:96px} .logo{width:44px;height:44px}}
</style>
</head>
<body>

<header>
  <div class="left-row">
    <div class="logo">J²</div>
    <div>
      <h1>JACOB'S ARCADE V4</h1>
      <div style="font-size:10px;color:var(--muted)">NEON BLUE HOME</div>
    </div>
  </div>

  <div class="top-controls">
    <div id="clock" style="font-size:11px;color:var(--neon-2);min-width:86px;text-align:center">00:00:00</div>
    <button id="deploy-roblox-btn" title="Deploy Roblox">DEPLOY ROBLOX</button>
    <button id="cloak-btn" class="btn small">CLOAK</button>
    <button id="customize-btn" class="btn small">CUSTOMIZE</button>
    <button id="login-toggle" class="btn small">LOGIN</button>
  </div>
</header>

<div class="container">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="profile">
      <div class="avatar" id="avatar">J</div>
      <div>
        <h3 id="profile-name">Guest</h3>
        <div style="font-size:10px;color:var(--muted)">Local demo account</div>
      </div>
    </div>

    <div style="margin-top:8px">
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px">CATEGORIES</div>
      <div class="category-list" id="category-list"></div>
    </div>

    <div style="margin-top:14px;">
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px">FAVORITES</div>
      <div id="fav-list" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <div style="margin-top:14px;font-size:11px;color:var(--muted)">
      <div style="margin-bottom:8px">PROXY SETTINGS</div>
      <input id="proxy-url-input" placeholder="Proxy URL (worker)" style="width:100%;padding:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--neon);font-size:12px">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="save-proxy" class="btn small">Save</button>
        <button id="clear-proxy" class="btn small">Clear</button>
      </div>
      <div style="margin-top:12px;font-size:10px;color:var(--muted)">Proxy persists after refresh if saved.</div>
    </div>

  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="controls">
      <input id="search-games" placeholder="SEARCH GAMES..." />
      <select id="category-filter" class="small">
        <option value="">All Categories</option>
      </select>
      <button id="show-faves" class="btn small">Show Favorites</button>
      <button id="clear-faves" class="btn small">Clear Favorites</button>
      <button id="cloak-quick" class="btn ghost small">Quick Cloak</button>
    </div>

    <div class="banner" id="custom-banner">Press PLAY to start a game — loading messages are chaotic!</div>

    <div class="grid" id="games-grid"></div>
  </main>
</div>

<!-- LOADING (GOOFY MESSAGES + PROGRESS) -->
<div id="loading-overlay">
  <div class="load-box" role="status" aria-live="polite">
    <div class="loading-msg" id="loading-msg">Loading...</div>
    <div class="progress" aria-hidden="true"><i id="loading-bar"></i></div>
    <div style="margin-top:10px;font-size:11px;color:var(--muted)">This sometimes takes 0.5–3s (simulated)</div>
  </div>
</div>

<!-- PROXY OVERLAY (full-screen embedded page in same tab) -->
<div id="proxy-overlay">
  <button id="proxy-back" title="Back to Arcade">← BACK</button>
  <iframe id="proxy-iframe" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
</div>

<!-- CLOAK (fake docs) -->
<div id="cloak-overlay" style="display:none;flex-direction:column">
  <div class="doc-header">
    <div style="font-weight:700;color:#1a73e8">Docs — Jacob's Arcade</div>
    <input class="doc-input" value="Untitled document" />
    <div class="help">Auto-saved • All changes saved</div>
    <div style="flex:1"></div>
    <button id="cloak-close" class="btn small">Return</button>
  </div>
  <iframe src="about:blank" style="flex:1;border:0"></iframe>
</div>

<!-- LOGIN / SIGNUP -->
<div id="login-screen" style="position:fixed;inset:0;display:none;background:rgba(0,0,0,0.92);z-index:8000;align-items:center;justify-content:center">
  <div style="background:#0b0b0d;padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);width:340px;text-align:center">
    <h3 style="margin:6px 0;color:var(--neon)">Login</h3>
    <input id="login-username" placeholder="username" style="width:100%;padding:8px;margin-top:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--neon)">
    <input id="login-password" placeholder="password" type="password" style="width:100%;padding:8px;margin-top:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--neon)">
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
      <button id="login-btn" class="btn small">LOGIN</button>
      <button id="show-signup" class="btn small">SIGNUP</button>
    </div>
    <div id="login-error" style="display:none;color:#ff6b6b;margin-top:8px;font-size:12px"></div>
  </div>
</div>

<div id="signup-screen" style="position:fixed;inset:0;display:none;background:rgba(0,0,0,0.92);z-index:8000;align-items:center;justify-content:center">
  <div style="background:#0b0b0d;padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);width:340px;text-align:center">
    <h3 style="margin:6px 0;color:var(--neon)">Sign Up</h3>
    <input id="signup-username" placeholder="username" style="width:100%;padding:8px;margin-top:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--neon)">
    <input id="signup-password" placeholder="password" type="password" style="width:100%;padding:8px;margin-top:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--neon)">
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
      <button id="create-account" class="btn small">CREATE</button>
      <button id="back-login" class="btn small">BACK</button>
    </div>
    <div id="signup-error" style="display:none;color:#ff6b6b;margin-top:8px;font-size:12px"></div>
  </div>
</div>

<footer>FOLLOW — YOUTUBE / TWITCH / TIKTOK</footer>

<script>
/* ----------------- GAME LIST (user-provided filenames) ----------------- */
const GAME_FILES = [
"1v1lol.html","amanda.html","aquapark.html","bad-parenting-1.html","baldis-basics.html",
"baseball-bros.html","basket-bros.html","bitlife.html","block-blast.html","bowmasters.html",
"buildnow.gg.html","clash-of-vikings.html","cuphead-1.html","do-not-take-this-cat-home.html",
"fears-to-fathom-home-alone.html","flip-master.html","football-bros.html","friday-night-funkin.html",
"justfall.lol.html","kindergarten-2.html","kindergarten-3.html","kindergarten.html","minecraft-1.21.4.html",
"retro-bowl.html","run-1.html","run-2.html","run-3.html","schoolboy-runaway.html","slither.io.html",
"slope.html","sonic-mania.html","sonic-the-hedgehog-2-communitys-cut.html","sonic-the-hedgehog-3-angel-island-remastered.html",
"sonic.exe.html","steal-brainrot-online.html","stickman-fight-ragdoll.html","stickman-hook.html",
"subway-surfers-barcelona.html","super-mario-bros.html","supreme-duelists.html"
];

/* ----------------- GOOFY LOADING MESSAGES ----------------- */
const LOADING_MESSAGES = [
"Loading... bruh the hamster fell off the wheel",
"Game is booting up... it’s lagging like your WiFi",
"Hold on, the pixels are arguing again",
"Loading... your PC is crying but it’ll be okay",
"DANAT IS BEING DANAT",
"Summoning the joystick spirits",
"Applying duct tape to the physics engine",
"Borrowing energy from Pluto",
"getting ram power frm peterbot",
"Whispering to the WASM gods",
"Polishing Jacob's math homework",
"Polishing the coin animations",
"Charging the fun capacitor",
"Installing patch: 'less rage'",
"Feeding the audio mixer with optimism",
"getting VC from 2k26",
"sommoning extra luck for charlies keyboard",
"opening clips from when I 1v1'd charlie",
"Charlie farted and it stinks",
"Nolan wondering how I made this!"
];

/* ----------------- HELPERS ----------------- */
function qsel(s){return document.querySelector(s)}
function qall(s){return Array.from(document.querySelectorAll(s))}
function wait(ms){return new Promise(r=>setTimeout(r,ms))}
function pad(n){return n.toString().padStart(2,'0')}
function randFrom(a){return a[Math.floor(Math.random()*a.length)]}

/* ----------------- SIMPLE SVG THUMBNAIL GENERATOR (AI-like: text-based) */
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;') }
function shorten(s,n){ if(s.length<=n) return s; return s.slice(0,n-1)+'…' }
function fileToTitle(fn){ return fn.replace(/\.html?$/i,'').replace(/[-_.]/g,' ').toUpperCase() }
function makeThumb(title){
  const bg = '#071019';
  const text = escapeHtml(shorten(title,30));
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='460'>
    <defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#00e6ff'/><stop offset='1' stop-color='#7cff00'/></linearGradient></defs>
    <rect width='100%' height='100%' fill='${bg}' rx='12'/>
    <text x='50%' y='44%' fill='white' font-family='Press Start 2P, Arial' font-size='28' dominant-baseline='middle' text-anchor='middle' fill-opacity='0.95'>${text}</text>
    <rect x='0' y='360' width='100%' height='100' fill='url(#g)' fill-opacity='0.08'/>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/* ----------------- CATEGORIES heuristic ----------------- */
const CATS = { 'Platform':[], 'Arcade':[], 'Sports':[], 'Sim':[], 'Rhythm':[], 'Action':[], 'Other':[] };
function assignCategory(fn){
  const lower = fn.toLowerCase();
  if(/sonic|mario|cuphead|minecraft|super|sonic-man/i.test(lower)) return 'Platform';
  if(/run|slope|slither|justfall|flip|stickman|block-blast|1v1lol|steal|schoolboy/i.test(lower)) return 'Arcade';
  if(/football|baseball|retro-bowl|basket|subway-surfers/i.test(lower)) return 'Sports';
  if(/bitlife|buildnow|minecraft|buildnow.gg/i.test(lower)) return 'Sim';
  if(/friday|funkin|rhythm|fnaf/i.test(lower)) return 'Rhythm';
  if(/clash|bowmasters|supreme|sonic.exe|bad-parenting|steal|fight|hook/i.test(lower)) return 'Action';
  return 'Other';
}

/* ----------------- PERSISTENCE & PREFS ----------------- */
const prefs = {
  favs: JSON.parse(localStorage.getItem('pref-favs')||'[]'),
  neon: localStorage.getItem('pref-neon')||'#00e6ff',
  proxyUrl: localStorage.getItem('proxy-url')||'https://tkmafsenoo.coaching2lead.com',
  proxyActive: localStorage.getItem('proxy-active')==='1'
};

/* ----------------- BUILD CATALOG ----------------- */
let CATALOG = [];
function buildCatalog(){
  const items = GAME_FILES.map(fn=>{
    const title = fileToTitle(fn);
    const cat = assignCategory(fn) || 'Other';
    return {file:fn, title, cat, thumb: makeThumb(title)};
  });
  // reset CATS
  Object.keys(CATS).forEach(k=>CATS[k]=[]);
  items.forEach(it=>{ if(CATS[it.cat]) CATS[it.cat].push(it); else CATS.Other.push(it); });
  CATALOG = items;
}
buildCatalog();

/* ----------------- RENDERING ----------------- */
const grid = qsel('#games-grid');
const catListEl = qsel('#category-list');
const categoryFilter = qsel('#category-filter');

function renderCategories(){
  catListEl.innerHTML=''; categoryFilter.innerHTML = '<option value="">All Categories</option>';
  Object.keys(CATS).forEach(cat=>{
    const btn = document.createElement('div');
    btn.className='category';
    btn.textContent = `${cat} (${CATS[cat].length})`;
    btn.onclick = ()=> { qall('.category').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); renderGames(cat); }
    catListEl.appendChild(btn);
    const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; categoryFilter.appendChild(opt);
  });
}

function renderGames(filter='', search=''){
  grid.innerHTML='';
  let list = CATALOG.slice();
  if(filter && filter!=='') list = list.filter(it=>it.cat===filter);
  if(search && search.trim()!=='') list = list.filter(it=> it.title.toLowerCase().includes(search.toLowerCase()));
  if(filter==='__FAVS__') list = list.filter(it=> prefs.favs.includes(it.file));
  list.forEach(it=>{
    const card = document.createElement('div'); card.className='card';
    const fav = document.createElement('div'); fav.className='fav'; fav.title='Toggle favorite';
    fav.innerHTML = prefs.favs.includes(it.file)?'⭐':'☆';
    fav.onclick = (e)=>{ e.stopPropagation(); toggleFav(it.file); fav.innerHTML = prefs.favs.includes(it.file)?'⭐':'☆'; renderFavList(); };
    const img = document.createElement('img'); img.className='thumb'; img.src = it.thumb; img.alt = it.title; img.loading = 'lazy';
    const title = document.createElement('div'); title.className='title'; title.textContent = it.title;
    const tags = document.createElement('div'); tags.innerHTML = `<span class="tag">${it.cat}</span>`;
    const ctrls = document.createElement('div'); ctrls.className='card-ctrls';
    const play = document.createElement('button'); play.className='tiny btn'; play.textContent='PLAY';
    play.onclick = ()=> playGame(it.file);
    const pop = document.createElement('button'); pop.className='tiny btn'; pop.textContent='POP-OUT';
    pop.onclick = (e)=> { e.stopPropagation(); openAboutBlank(it.file, it.title); };
    const cloakBtn = document.createElement('button'); cloakBtn.className='tiny btn ghost'; cloakBtn.textContent='CLOAK';
    cloakBtn.onclick = ()=> quickCloak();
    ctrls.append(play, pop, cloakBtn);
    card.appendChild(fav); card.appendChild(img); card.appendChild(title); card.appendChild(tags); card.appendChild(ctrls);
    grid.appendChild(card);
  });
  if(list.length===0){
    grid.innerHTML = `<div style="color:var(--muted);padding:30px;font-size:12px">No games found</div>`;
  }
}

/* ----------------- FAV LIST ----------------- */
function renderFavList(){
  const out = qsel('#fav-list'); out.innerHTML='';
  prefs.favs.forEach(fn=>{
    const title = fileToTitle(fn);
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
    el.style.padding='6px'; el.style.borderRadius='6px'; el.style.fontSize='12px'; el.style.border='1px solid rgba(255,255,255,0.02)';
    el.innerHTML = `<div>${title}</div><div style="display:flex;gap:6px"><button class="btn small" onclick="playGame('${fn}')">PLAY</button><button class="btn small" onclick="toggleFav('${fn}');renderFavList();renderGames();">REMOVE</button></div>`;
    out.appendChild(el);
  });
}

/* ----------------- FAVORITES ----------------- */
function toggleFav(fn){
  if(!prefs.favs.includes(fn)) prefs.favs.push(fn);
  else prefs.favs = prefs.favs.filter(x=>x!==fn);
  localStorage.setItem('pref-favs', JSON.stringify(prefs.favs));
  renderGames(categoryFilter.value || '', qsel('#search-games').value);
}

/* ----------------- LOADING / PROGRESS UI (shared) ----------------- */
const loadingOverlay = qsel('#loading-overlay');
const loadingMsg = qsel('#loading-msg');
const loadingBar = qsel('#loading-bar');

async function showLoadingAndProgress(message){
  loadingMsg.textContent = message;
  loadingBar.style.width = '0%';
  loadingOverlay.style.display = 'flex';
  // simulate neon electric pulse progress
  const duration = 800 + Math.random()*2000; // 0.8 - 2.8s
  const start = Date.now();
  while(Date.now() - start < duration){
    const t = (Date.now() - start) / duration;
    // ease with small pulse
    const pct = Math.min(100, Math.floor( (Math.sin(t*Math.PI*1.5)*0.1 + t*0.9) * 100 ));
    loadingBar.style.width = pct + '%';
    await wait(70);
  }
  loadingBar.style.width = '100%';
  await wait(140);
}

function hideLoading(){
  loadingOverlay.style.display = 'none';
  loadingBar.style.width = '0%';
}

/* ----------------- PLAY a game (same-tab) ----------------- */
async function playGame(url){
  // show goofy message then navigate same-tab
  const msg = randFrom(LOADING_MESSAGES);
  await showLoadingAndProgress(msg);
  hideLoading();
  // navigate in same tab (user wanted same-tab)
  window.location.href = url;
}

/* ----------------- POP-OUT ABOUT:BLANK (still shows goofy messages and loads blob) ----------------- */
async function openAboutBlank(url, title){
  // show goofy message first
  const msg = randFrom(LOADING_MESSAGES);
  await showLoadingAndProgress(msg);
  // open about:blank and inject fetched content as blob to preserve relative assets
  try{
    const w = window.open('about:blank');
    if(!w){ hideLoading(); return alert('Popup blocked. Allow popups for this site.'); }
    // attempt to fetch file text
    const res = await fetch(url).catch(()=>null);
    if(res && res.ok){
      const txt = await res.text();
      const blob = new Blob([txt], {type:'text/html'});
      const blobUrl = URL.createObjectURL(blob);
      const doc = w.document;
      const wrapper = `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>html,body{height:100%;margin:0;background:#000}iframe{border:0;width:100%;height:100%}</style></head><body><iframe src="${blobUrl}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe></body></html>`;
      doc.open();
      doc.write(wrapper);
      doc.close();
    } else {
      // fallback message if file not found
      w.document.write(`<div style="background:#000;color:#fff;height:100vh;display:flex;align-items:center;justify-content:center;font-family:Arial">File not found: ${title}</div>`);
      w.document.close();
    }
  }catch(err){
    console.error(err);
    alert('Failed to open pop-out');
  } finally {
    hideLoading();
  }
}

/* ----------------- PROXY / DEPLOY BUTTON (full embedded page in same tab, floating back button) ----------------- */
const proxyOverlay = qsel('#proxy-overlay');
const proxyIframe = qsel('#proxy-iframe');
const proxyBack = qsel('#proxy-back');
const proxyBtn = qsel('#deploy-proxy-btn');
const proxyUrlInput = qsel('#proxy-url-input');
const saveProxyBtn = qsel('#save-proxy');
const clearProxyBtn = qsel('#clear-proxy');

proxyUrlInput.value = prefs.proxyUrl || '';

function showProxy(url){
  // always use same-tab visual takeover via overlay with iframe
  proxyIframe.src = url;
  proxyOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  localStorage.setItem('proxy-active','1');
  prefs.proxyActive = true;
  localStorage.setItem('proxy-url', url);
  prefs.proxyUrl = url;
  // floating back button is visible (#proxy-back)
}

/* clicking deploy uses the saved proxy url or prompt */
proxyBtn.addEventListener('click', ()=>{
  let url = proxyUrlInput.value.trim() || prefs.proxyUrl || 'https://tkmafsenoo.coaching2lead.com';
  if(!url){
    url = prompt('Enter proxy/worker URL (https://...)') || '';
    if(!url) return;
    proxyUrlInput.value = url;
  }
  // save and show
  localStorage.setItem('proxy-url', url);
  prefs.proxyUrl = url;
  showProxy(url);
});

/* back button hides overlay and clears active state but preserves saved URL */
proxyBack.addEventListener('click', ()=>{
  proxyIframe.src = 'about:blank';
  proxyOverlay.style.display = 'none';
  document.body.style.overflow = '';
  localStorage.removeItem('proxy-active');
  prefs.proxyActive = false;
});

/* manual save/clear proxy in sidebar */
saveProxyBtn.addEventListener('click', ()=>{
  const u = proxyUrlInput.value.trim();
  if(!u) return alert('Enter a valid url first');
  localStorage.setItem('proxy-url', u);
  prefs.proxyUrl = u;
  alert('Proxy URL saved');
});
clearProxyBtn.addEventListener('click', ()=>{
  proxyUrlInput.value = '';
  localStorage.removeItem('proxy-url');
  prefs.proxyUrl = '';
  alert('Proxy cleared');
});

/* restore proxy on load if previously active (fix for "stopped showing after refresh") */
window.addEventListener('load', ()=>{
  if(prefs.proxyActive && prefs.proxyUrl){
    // small delay so DOM is ready
    setTimeout(()=> showProxy(prefs.proxyUrl), 140);
  }
});

/* make back button easier to click with keyboard ESC */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && proxyOverlay.style.display === 'flex') proxyBack.click();
});

/* ----------------- CLOCK ----------------- */
function updateClock(){ const now = new Date(); qsel('#clock').textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}` }
setInterval(updateClock,1000); updateClock();

/* ----------------- CLOAK overlay ----------------- */
const cloakOverlay = qsel('#cloak-overlay');
const cloakBtn = qsel('#cloak-btn');
const cloakClose = qsel('#cloak-close');
const cloakQuick = qsel('#cloak-quick');

function openCloak(){ cloakOverlay.style.display='flex'; }
function closeCloak(){ cloakOverlay.style.display='none'; }
cloakBtn.addEventListener('click', openCloak);
cloakClose.addEventListener('click', closeCloak);
cloakQuick.addEventListener('click', ()=>{ openCloak(); setTimeout(()=>closeCloak(), 600); });

/* ----------------- AUTH (local demo) ----------------- */
const loginScreen = qsel('#login-screen');
const signupScreen = qsel('#signup-screen');
const loginToggle = qsel('#login-toggle');
const showSignupBtn = qsel('#show-signup');
const backLoginBtn = qsel('#back-login');
const loginBtn = qsel('#login-btn');
const createAccountBtn = qsel('#create-account');

loginToggle.addEventListener('click', ()=> { loginScreen.style.display='flex' });
showSignupBtn.addEventListener('click', ()=> { loginScreen.style.display='none'; signupScreen.style.display='flex' });
backLoginBtn.addEventListener('click', ()=> { signupScreen.style.display='none'; loginScreen.style.display='flex' });

async function sha256hex(str){
  const enc = new TextEncoder(); const data = enc.encode(str); const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function getAccounts(){ return JSON.parse(localStorage.getItem('accounts')||'{}') }

createAccountBtn.addEventListener('click', async ()=>{
  const u = qsel('#signup-username').value.trim(); const p = qsel('#signup-password').value;
  if(!u||!p){ qsel('#signup-error').textContent='Fill both fields'; qsel('#signup-error').style.display='block'; return; }
  const accounts = getAccounts(); if(accounts[u]){ qsel('#signup-error').textContent='Username exists'; qsel('#signup-error').style.display='block'; return; }
  const h = await sha256hex(p); accounts[u]=h; localStorage.setItem('accounts', JSON.stringify(accounts)); alert('Account created — login now'); signupScreen.style.display='none'; loginScreen.style.display='flex';
});

loginBtn.addEventListener('click', async ()=>{
  const u = qsel('#login-username').value.trim(); const p = qsel('#login-password').value;
  const accounts = getAccounts(); const h = await sha256hex(p);
  if(!accounts[u] || accounts[u]!==h){ qsel('#login-error').textContent='Invalid'; qsel('#login-error').style.display='block'; return; }
  qsel('#login-error').style.display='none';
  loginScreen.style.display='none';
  grantAccess(u);
});

function grantAccess(username){
  qsel('#profile-name').textContent = username;
  qsel('#avatar').textContent = username[0].toUpperCase();
  // optional visual feedback
  const ag = document.createElement('div'); ag.textContent = 'ACCESS GRANTED'; ag.style.position='fixed'; ag.style.left='50%'; ag.style.top='40%'; ag.style.transform='translate(-50%,-50%)'; ag.style.background='#000'; ag.style.padding='18px'; ag.style.borderRadius='10px'; ag.style.zIndex=9200;
  document.body.appendChild(ag);
  setTimeout(()=>ag.remove(), 1100);
}

/* ----------------- UI wiring ----------------- */
qsel('#search-games').addEventListener('input', (e)=> renderGames(categoryFilter.value || '', e.target.value));
categoryFilter.addEventListener('change', ()=> renderGames(categoryFilter.value || '', qsel('#search-games').value));
qsel('#show-faves').addEventListener('click', ()=> { renderGames('__FAVS__'); });
qsel('#clear-faves').addEventListener('click', ()=> { prefs.favs=[]; localStorage.setItem('pref-favs', JSON.stringify(prefs.favs)); renderGames(); renderFavList(); });

/* ----------------- INIT render ----------------- */
(function init(){
  renderCategories();
  renderGames();
  renderFavList();
  proxyUrlInput.value = prefs.proxyUrl || '';
  // ensure saved proxyActive is honored after page load (if user left proxy open previously)
  if(localStorage.getItem('proxy-active') === '1'){
    const saved = localStorage.getItem('proxy-url') || prefs.proxyUrl;
    if(saved) setTimeout(()=> showProxy(saved), 120);
  }
})();

/* ----------------- expose a couple helper functions to inline onclicks in favorite list (global) */
window.playGame = playGame;
window.toggleFav = toggleFav;
window.openAboutBlank = openAboutBlank;

</script>
</body>
</html>
